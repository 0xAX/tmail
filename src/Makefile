# tmail Makefile
#
# Copyright (C) 2017 Alexander Kuleshov <kuleshovmail at gmail dot com>
# This file is released under the BSD license, see the COPYING file

.DEFAULT_GOAL: $(TMAIL_EXECUTABLE)

include ../mk/Common.mk
include ../mk/Build.mk

# external libraries that are used by tmail
ifndef SSL_DISABLED
LIBS += -lssl -lcrypto
endif

# lexer and parser source code
CONFIG_PARSER = config_parser.y
CONFIG_LEXER = config_parser.l

# object files for tmail
TMAIL_OBJS += config.o
TMAIL_OBJS += tmail.o
TMAIL_OBJS += mime.o
TMAIL_OBJS += message.o
TMAIL_OBJS += send-email.o
TMAIL_OBJS += smtp-caps.o
TMAIL_OBJS += smtp-server-info.o

# object files for sys lib
SYS_OBJS += libsys/at_exit.o
SYS_OBJS += libsys/connect.o
SYS_OBJS += libsys/fcntl_utils.o
SYS_OBJS += libsys/gethostname.o
SYS_OBJS += libsys/inet.o

# object files for utils lib
UTILS_OBJS += libutils/list.o
UTILS_OBJS += libutils/stack.o
UTILS_OBJS += libutils/hashmap.o
UTILS_OBJS += libutils/string_utils.o

# object files for smtp lib
ifndef SSL_DISABLED
SMTP_OBJS += libsmtp/starttls.o
endif
SMTP_OBJS += libsmtp/attachment.o
SMTP_OBJS += libsmtp/help.o
SMTP_OBJS += libsmtp/ehlo.o
SMTP_OBJS += libsmtp/smtpauth.o
SMTP_OBJS += libsmtp/mail_from.o
SMTP_OBJS += libsmtp/rcpt_to.o
SMTP_OBJS += libsmtp/data_msg.o
SMTP_OBJS += libsmtp/body.o
SMTP_OBJS += libsmtp/quit.o
SMTP_OBJS += libsmtp/smtp.o

# Object files generated by flex/bison
PARSER_OBJECTS = config_parser.tab.o lex.yy.o

# object files for encoding lib
ENCODING_OBJS += libencoding/base64.o

# set of directories with C headers needed for tmail
INCLUDES+=-Ilibsys/
INCLUDES+=-Ilibutils/                    
INCLUDES+=-Ilibsmtp/
INCLUDES+=-Ilibencoding/
INCLUDES+=-I./

# Final compiler flags
COMPILER_FLAGS = $(INCLUDES) $(OSX_FLAGS) $(LINKER_OPTS) $(CC_EXEC_FLAGS)

# set of object file that linked together with tmail
TMAIL_OBJECT_FILES_DEPS += $(SYS_OBJS)
TMAIL_OBJECT_FILES_DEPS += $(UTILS_OBJS)
TMAIL_OBJECT_FILES_DEPS += $(PARSER_OBJECTS)
TMAIL_OBJECT_FILES_DEPS += $(ENCODING_OBJS)
TMAIL_OBJECT_FILES_DEPS += $(SMTP_OBJS)
TMAIL_OBJECT_FILES_DEPS += $(TMAIL_OBJS)

$(TMAIL_EXECUTABLE): $(PARSER_OBJECTS) $(TMAIL_OBJS)
	$(QUIET_CC) $(TMAIL_CC)	$(COMPILER_FLAGS) ../$@ $(LIBS) $(TMAIL_OBJECT_FILES_DEPS)

config_parser.tab.o: $(CONFIG_PARSER)
	$(BISON) -d -v $(CONFIG_PARSER)
	$(QUIET_CC) $(TMAIL_CC) $(OSX_FLAGS) $(INCLUDES) -c config_parser.tab.c

lex.yy.o: $(CONFIG_LEXER)
	$(FLEX) $(CONFIG_LEXER)
	$(QUIET_CC) $(TMAIL_CC) $(OSX_FLAGS) $(INCLUDES) -c lex.yy.c

%.o: %.c
	$(QUIET_CC) $(TMAIL_CC) $(DEFS) $(OSX_FLAGS) $(INCLUDES) $(CFLAGS_OBJS) $@ $<

$(CLEAN_TARGET):
	@echo "./src"
	$(QUIET_CLEAN_OBJECTS) $(RM) $(OBJECT_FILES)
	$(QUIET_CLEAN_OBJECTS) $(RM) *.output
	$(QUIET_CLEAN_OBJECTS) $(RM) *.tab.c *.tab.h *.tab.o *.yy.c
	@cd $(TMAIL_SYS_DIR) && $(MAKE) $(MAKE_FLAGS) $(CLEAN_TARGET)
	@cd $(TMAIL_UTILS_DIR) && $(MAKE) $(MAKE_FLAGS) $(CLEAN_TARGET)
	@cd $(TMAIL_SMTP_DIR) && $(MAKE) $(MAKE_FLAGS) $(CLEAN_TARGET)
	@cd $(TMAIL_ENCODING_DIR) && $(MAKE) $(MAKE_FLAGS) $(CLEAN_TARGET)
	@cd ./tests && $(MAKE) $(MAKE_FLAGS) $(CLEAN_TARGET)

.PHONY: $(CLEAN_TARGET)
